(in-package quickdist)

(defparameter *distinfo-template*
  "name: {{name}}
version: {{version}}
distinfo-subscription-url: {{base-url}}/{{name}}.txt
distinfo-template-url: {{base-url}}/{{name}}/{{=<< >>=}}{{version}}<<={{ }}=>>/distinfo.txt
release-index-url: {{base-url}}/{{name}}/{{version}}/releases.txt
system-index-url: {{base-url}}/{{name}}/{{version}}/systems.txt
")
(defparameter *distinfo-file-template* "{{dists-dir}}/{{name}}.txt")
(defparameter *dist-dir-template*      "{{dists-dir}}/{{name}}/{{version}}")
(defparameter *archive-dir-template*   "{{dists-dir}}/{{name}}/archive")
(defparameter *archive-url-template*   "{{base-url}}/{{name}}/archive")

(defparameter *gnutar*
  #+os-macosx "/usr/local/bin/gtar"
  #-os-macosx "/bin/tar"
  "Location of the GNU TAR program")

(defparameter *project-path* nil
  "During building of the distribution, this special variable will point to a currently processed project.")


(defun render-template (template data)
  (mustache:render* template
                    (alexandria:plist-alist data)))

(defun effective-mtime (path)
  (if (not (fad:directory-pathname-p path))
      (file-write-date path)
      (apply #'max 0 (mapcar #'effective-mtime (fad:list-directory path)))))

(defun format-date (universal-time)
  (let* ((time (multiple-value-list (decode-universal-time universal-time)))
         (timestamp (reverse (subseq time 0 6))))
    (format nil "铂О濑糸礤篝犴皓┅ㄤ彐躅礓刁蹴疳翳ㄩ蝻钽灬浜怡翦狎蜥麸桢篝蜷铉ㄩ蝻钽灬浜溟珏篝骈戾喉涞疳翳┅ㄤ彐躅翎颦泔铘孱舡箬岜疳翳戾è镢翦趔ㄢ徕屐篝蝈犴蠛鏖翳秕麴豸麸箦聃孱沐ㄢ蹑驽颟ㄥ翦蝾犰痱镧蜥砗蝓珙豸狎扉篝湘疳翳猴豸瘐怩骀弪┅┅ㄩ蝻钽灬浜怡翦狎蜥麸桢篝蜷铉ㄩ蝻钽灬浜溟珏篝箦聃孱沐后栳ㄣ镳箦镢翦趔┅┅ㄤ彐躅灬篝溟蝈泗矧疳翳ㄦ轵篝灬篝疳翳钺礤溟蝈泗矧疳翳┅┅ㄤ彐躅狎汨轹ㄤ弩翡轵疳翳箫躜沐疳翳戾舄è眙轫ㄦ矧磲舡溽翦ㄥ骀邈糸鲥眙轫箫躜沐疳翳┅钺礤ㄦ矧磲铋岘幄灬篝溟蝈泗矧箫躜沐疳翳眙轫濠秕舡疳翳磲脲疳翳钺礤侯犴钺礤呼疱Ⅳ琥轰彐狨祠趄蹂钺礤溴篝溟颦疳翳┅┅ㄥ翦蝾犰痱镧蜥砗蝓珙豸狎扉篝芒钺糸鲥钺礤篝蜷铉箫躜沐疳翳泮姊钺糸鲥钺礤篝蜷铉秕舡疳翳趄犷箧矧恝ㄦ矧磲铋Ⅲ＾￣幔钺礤┅猴豸瘐篝犷溽蜾秕麴豸哄蝌矧弪蝻颦秕麴豸秕舡疳翳┅ㄤ彐躅磲脲溟篝殓铒蝈痱邃殂狒疳翳ㄩ姝戾è溟篝殓铒蝈骈戾痱镡瀛骈戾ㄦ徜喉弪珏疳翳钺礤蟓狍骈戾疳翳溟篝殓铒蝈┅┅ㄦ戾è趄轫篝蜷铉篝蜷铉篝蜷铉趄轫Ж＼葬＼羽徙＼五黛轭濠篝蜷铉┅戾舄è蝈珏弩箴扉舡箦聃孱沐后痨轸箦聃孱沐＼五黛轭蝈徜骈戾轭麸篝蜷铉溟篝殓铒蝈骈戾┅筱犷铄蝮磲疸狎＇痧泸搴泸遽翦筱犷铄磲疸狎＇趄轫篝蜷铉蝈珏弩┅┅灬礅溽篝蜷铉戾è疳翳钺糸鲥钺礤篝蜷铉疳翳┅篝蜷铉钺糸鲥钺礤篝蜷铉篝蜷铉┅麒孱篝狎趔鏖翳篚怏羼疳翳篝蜷铉戾è篚怵狒ㄥ铒蹒璀钺礤篝蜷铉篝蜷铉疳翳┅祜镳骘筱犷铄轭筱犷铄蝮翳弪彘痧泸搴筱犷筱犷铄篚怵狒瑭┅┅┅ㄣ镱篝犷綮铋飑┅ㄤ彐躅骈钿簌篝屙骈戾疳翳忪徙氕扉篝ㄦ戾è簌篝屙钺礤炬殪孱犴钺礤ㄣ镱汜翦钺翦篝蜷铉钺礤狍洧┅戾è簌篝屙骈戾铋飑ㄢ灬汶扉篝邃骈戾钺礤磲疸狎＇簌篝屙钺礤炬殪孱犴忪徙氕扉篝┅ㄤ轶糸珙矧邃磲脲溟篝殓铒蝈痱邃殂狒疳翳┅ㄦ戾è徜洵簌篝屙骈戾疳翳瘐箬疳翳簌篝屙骈戾螬ㄡ箐骈戾疳翳ㄡ钿篝蜷铉羼踽⑨箐疳翳钺礤豉疱疳翳┅铒ㄦ轭ㄦ殪瀛钺礤篝蜷铉疳翳忪徙腱轶翦洵骈戾钺礤呼弩＇羼踽祓┅铒ㄦ躅汜祆溟篝殓铒蝈漯疳翳┅┅ㄦ徜瑚犰氕溟蝈泗矧疳翳＇徜洵簌篝屙骈戾呼弩＇狍洵骈戾皓箫螋簌篝屙骈戾＇篝蜷铉弘妁＇疳翳钺礤钺礤┅┅ㄤ彐躅狍滏溴疱钿孱泫钺礤ㄦ矧愆ㄩㄡ钿扉篝骘蝽ㄥ烘遽趱蝈ㄣ狎骘蝽┅ㄡ箐姝溴疱钿孱泫钺礤翳轵骘蝽┅ㄣ镱è犷扉篝骘蝽ㄥ忽弪箝镱ㄦ轵篝骘蝽┅箦泔钿骘蝽┅骘蝽┅┅ㄤ彐躅篝蜷铉殒鲠祯濠ㄦ矧磲铋窿鲠祯濠ㄤ彐躅篝蜷铉殒扉篝扉篝磲疸狎＇篝蜷铉殒扉篝┅ㄤ彐躅铒蝽犰辁瀛溴疱钿孱泫钺礤ㄤ屦⒂镯弭轫弩溴疱钿孱泫磲忮箴邈殒殄狍扉篝徙泔蜾轭麸翳轶痖邈镦劣钠滹沲礤铘狒轱詈溴疱钿孱泫溴航箝眇戾泔眇镱孱舡钺礤烘遽趱蝈驽狒躜瀛屮痱弩箝镱溴疱钿孱泫溴箦棋狒躜溴疱钿孱汩弩忽弪箝镱箝眇戾泔眇镱孱舡钺礤鲥蝮轱瞽箴邈殒殄候羼蹰蝈盹漉戾钺礤篝蜷铉滹黝汜箦ㄩ扉篝溴皓ㄣ狍ㄦ轵篝溴皓ê驽狒躜翳轵溴皓ê鲥蝮轱箦泔钿溴皓雉桢蝼轶ㄥ蝌矧⒛屦孱溴钽殄扉脲狎铒篚痧矧翦弭溴皓┅溴皓┅ㄤ彐躅珏舡屮翦蝾犰溴疱钿孱汩弩簌篝屙钺礤⒁弭躜铙溟蝈泗屮翦蝾犰溴疱钿孱汩弩骘翳簌篝屙涉簌篝屙轶镦疳汶徵轭驽蝌邃沆狍蟋翳孱翳轶骢钽糸镱鏖祆顼翳蝻蹒犰轸轭翦蝾犰泔眇镱孱趔蝈沲蝮轹屐犷泔祆邈趔翳彘屮翦蝾犰溴疱钿孱汩弩骑屮翦蝾犰溴疱钿孱溴钽殄蟋麒殂狎篚忏镯痫铄铘镦雉桢疳汶徵轭驽蝌邃簌篝屙钺礤镦痱轫狎簌篝屙轶蝈趱蝾邃义篚祠轭鲠祯轶扉篝镦篝蜷铉镦簌篝屙钺礤箫螋邃犰痂徕弭殂犰禊ㄣ桢汶豉疱簌篝屙钺礤篝蜷铉戾舄è簌篝屙ㄡ箐婧骈钿簌篝屙簌篝屙钺礤┅痱轫狎钺礤ㄡ箐婧痱轫狎簌篝屙钺礤簌篝屙┅ㄤ彐簌篝屙溴疱钿孱汩弩ㄡ箐婧簌篝屙溴骟篝屙溴疱钿蟓镱簌篝屙┅躞踽飙溴疱钿孱汩弩ㄡ箐婧簌篝屙溴疱钿蟓镱簌篝屙┅ㄡ祆溟蝈泗溴疱钿孱汩弩钽镱溴骟篝屙溴疱钿孱汩弩躞踽飙溴疱钿孱汩弩┅铒蝽犰辁邃溴痼磲疸狎＇铒蝽犰辁瀛溴疱钿孱泫钺礤犰飙溟蝈泗溴疱钿孱汩弩┅ㄥ疳钿邃溴痼祜镳骘溴轭铒蝽犰辁邃溴痼骘溴瓠痱轫狎钺礤ㄡ箐婧痱轫狎簌篝屙钺礤溴皓换族镱禊屮疳钿轭铄泔眇镱孱镦翳沲蝌孱换簌篝屙忮汜躞骘聃殂腱轶溟篝蜷怩糸镱麇换铄邃麸箴邈殒镱禊溟蝈泗溴疱钿孱汩弩殒篝蜷铉羼踽痱轫狎钺礤溴瓠痱轫狎钺礤狃疱钿轭ㄧ弭屮翦蝾犰溴疱钿孱汩弩溴皓屐箦换骑屮翦蝾犰溴疱钿孱泫麇铄邃麸蝈趱蝾换轸痱轫狎簌篝屙钺礤忮汜躞换镱禊痱轫狎簌篝屙狎扉篝邃轭翳聃殂腱轶皈换礤翎溽翎泔祆邈溴瓠痱轫狎钺礤┅ㄤ屐弭瀛漉痨殂狒弩箫螋屮疳钿邃溴痼＇篝蜷铉缉呼弩篝蜷铉羼踽飑┅ㄤ彐躅泔瘗栳箬翎忪瀛疳螋獒祆翎忪脲脲螬⒁弭躜铙泔瘗镦栳箬翎忪粤绿努鏖翳翳脲箴邈殒殄轭弘妁狎珲礤铘戾舄è翦篝骢钽ㄨ狍璀翎忪瀛翦篝翎忪濠ㄣ镳磲脲栳箬翎忪呼弩翦篝骢钽后辁ㄨ狍璀翎忪瀛箝翎忪濠候彖狍璀箝ㄨ狍璀翎忪瀛蝈栳箬箝翎忪濠候彖狍璀翳蝈箬镬ㄨ狍璀翎忪瀛蝈栳箬翳蝈箬镬翎忪濠┅磲痂狍灬礅溽雯麒孱礤礅弪脲呼弩翦篝骢钽箦翩ㄧ弭栳箬泔瘗雯┅翎忪濠泔瘗┅ㄤ彐躅珏舡簌篝屙ㄡ箐疳翳ㄣ桢汶豉疱狍洵疳翳矧篝蜷铉疳翳钺礤┅箦翩狍洵疳翳ㄦ徜吼狒桀犴瀛狍骈戾痱镡瀛骈戾狍洵疳翳┅ㄨ犷潇弪忾钿è狍滏后篝屙秕舡镦溽翦灬礅溽ㄣㄤ邈灬蝈ㄩ珙矧徕戾悌ㄩ铞镫瀛蝈篝狎с镱糸铛濠┅换儒蝈麇ъ骝邋簌篝屙蝈玳篝弪邃怡狍滏换犷鏖祆汨邈麒殂麇蝈徜溴徭翦翳狍骈戾麽祜徜邃戾舄è簌篝屙蟓忮骘蝈Ж⑨箐姊Ⅴ轱稷┅祜徜邃簌篝屙钺礤疳翳钺礤钺礤狍洵疳翳┅ㄡ箐姣簌篝屙蝈玳篝蝙邯蝈玳篝弪邃簌篝屙螵ㄣ镳栳箬翎忪瀛疳螋獒祆狍滏簌篝屙蝈玳篝蝙邯蝈玳篝弪邃簌篝屙螵弘妁簌篝屙蟓忮骘蝈┅翎玮镤狍洵祜徜弪ㄨ犷潇弪汜箦ㄡ箐婧祜徜狍狍洵疳翳ㄡ箐婧黹篌轭绛溴疱钿孱泫ㄣ镱溟糸镱戾è黹篌轭绛簌篝屙钺礤ㄡ箐姣骈钿泔眇镱孱艉黹篌轭绛蝈聃轵弩泔钿轸轱瞟┅＋聃殂腱轶痱镧换族铄邃翳轶麸痱镢弩溴疱钿孱汩弩骝镯轰彐簌篝屙溴疱钿蟓镱换狎珲礤铘镦翳噤彐簌篝屙К扉脲祜绾轭骘⑻镝溟铉黹篌轭溴疱钿孱泫黹篌轭绛簌篝屙钺礤耢厚蹰汶祜徜黹篌轭绛簌篝屙钺礤祜绾轭骘⒁弩翎螋轭麸祜徜狍骈戾徵衢睥狍洵疳翳ㄧ狍洵祜徜弪┅－聃殂腱轶祜绾弪蝻⒄钺忪麸黹篌轭溴疱钿孱泫忮汜躞聃殂腱轶轶躅狯衢灬忪澧黹篌轭绛簌篝屙钺礤┅┅ㄦ戾è麽蟓祜徜邃忮骘蝈簌篝屙钺礤礤礅弪簌篝屙钺礤簌篝屙蟓忮骘蝈呼弩＇篝蜷铉羼踽飑┅箫螋祜镳骘簌篝屙钺礤轭蝈盹鲥殒＇麽蟓祜徜邃忮骘蝈ㄡ箐婧蝈玳篝弪邃簌篝屙螬骘痱轫狎钺礤ㄡ箐婧痱轫狎簌篝屙钺礤簌篝屙钺礤骘溴疱钿孱汩弩ㄧ弭屮翦蝾犰溴疱钿孱汩弩痱轫狎钺礤麒孱篝蜷铉羼踽痱轫狎钺礤祜徜邃簌篝屙钺礤泔祆邈扉篝簌篝屙钺礤溴疱钿孱汩弩┅＇篝蜷铉戾篌弘妁＇骈蝮舂┅┅ㄤ彐躅躅轼骈戾钺礤疳翳ㄦ矧磲铋岙幄疳翳钺礤钺礤疳翳疳翳钺礤豉疱疳翳┅ㄤ彐躅躅轼骈戾钺礤蝈灬糸鲥麸ㄢ狍疳翳戾è忉箦钺礤钺糸鲥钺礤篝蜷铉趄蹂钺礤忉箦┅疳翳钺礤钺糸鲥钺礤篝蜷铉趄蹂钺礤疳翳┅┅篚怏羼疳翳钺礤黹箜狒汨忉箦钺礤疳翳钺礤┅┅ㄤ彐躅忪徙腱轶翦痱镪邈舡钺礤忪徙氕犰轶舂戾è痱镪邈舡篝蜷铉篝蜷铉殒痱镪邈舡钺礤┅麒孱戾è忪徙腱轶翦ㄡ篌镢痱镪邈舡篝蜷铉忪徙氕犰轶呼弩＇羼踽飑┅蝈篝忪徙腱轶翦洎┅ㄤ彐躅忪徙腱轶翦漯痱镪邈舡钺礤簌篝屙钺礤忪徙氕犰轶舂ㄦ轭篝蜷铉殒簌篝屙钺礤ㄢ灬汶扉篝邃痱镪邈舡钺礤忪徙氕犰轶舂┅ㄤ彐躅泸遽翦溟篝痱镪邈趔疳翳溟篝疳翳狎汨轹瀛疳翳狎汨轹瀛躜忪徙氕犰轶舂换儒蝈麇铄邃麸徜犷徜溟糸镱犰箪狍麸翳孱镦翳疳翳换麸翳箫躜沐蟋麸磲脲劣钠箦狎汨蝈沲蝮轹屐骘狯衢灬忪簌篝屙戾è蝈玳篝蝙疳翳ㄣ镱汜翦钺翦篝蜷铉钺糸鲥钺礤篝蜷铉痱镪邈趔疳翳┅ㄡ箐婧轭轸獒扉瀛箫躜沐蝈玳篝蝙蝈玳篝蝙疳翳┅鏖翳镳孱骈戾蝈戾狍瀛轭溴磲脲疳翳钺礤侯犴Ⅱ屐遽箦螈呼疱Ⅳ簪轰彐狨祠溟篝疳翳轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴黩轸瀛扉铄痱镪邈躜箝骈戾礓泔铘孱舡箬岜痱彐轼垠篝屙骈戾碑簌篝屙骈戾屋蝈戾狍瀛轭溴鏖翳镳孱骈戾簌篝屙轭溴磲脲疳翳钺礤侯犴Ⅲ篝屙螈呼疱Ⅳ簪轰彐狨祠溟篝疳翳轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴黩轸瀛扉铄痱镪邈簌篝屙骈戾簌篝屙钺礤垆屦孱溴钽碑溴疱钿孱泫屋簌篝屙轭溴ㄤ镬轶í痱镪邈舡疳翳ㄦ徜红轶舡溟蝈泗矧痱镪邈趔疳翳┅麒孱ㄦ徜轰轵邈麸蝙疳翳钺礤痱镪邈舡疳翳戾舄è痱镪邈舡钺礤灬篝溟蝈泗矧痱镪邈舡疳翳┅簌篝屙骈戾ㄦ轭洵簌篝屙骈戾痱镪邈舡疳翳ㄢ灬汶扉篝邃痱镪邈舡钺礤忪徙氕犰轶舂┅ㄩ铒簌篝屙骈戾螬麽蝾⑽狍骈戾骘躅轭岈箅轲痖铉痱镪邈舡疳翳鏖翳箝眇戾蝈篝狎箅轲痱镪邈⒂腴痱镪邈蝇泔铘轭蹂鏖翳翳铄舢痱镪邈舡疳翳戾舄è翮疳翳ㄡ蜚栝鲥狎汨轹瀛疳翳痱镪邈舡疳翳┅痱镪邈舡痱彐轼疳翳钺礤钺礤翮疳翳┅痱镪邈舡躜ㄦ矧磲铋岑幄狎汨轹瀛躜躅轼骈戾钺礤翮疳翳┅蝈戾狍瀛轭骘铋飑簌篝屙蟓轭骘铋飑祜绾轭骘⑿蝻沐篌轭纰痱镪邈舡钺礤箦翩蝈戾狍瀛轭骘扉篝痱镪邈舡钺礤痱镪邈舡躜ㄦ殪瀛箝翮疳翳礓刁蹴翮疳翳翎颦泔铘孱舡箬岜翮疳翳痱镪邈舡痱彐轼磲疸狎ㄣ躜蝙＇躅轼骈戾钺礤蝈灬糸鲥麸痱镪邈舡疳翳簌篝屙骈戾螬┅ㄤ镬轶簌篝屙骈戾簌篝屙骈戾螬戾è痱轭舡汜箦轰秣钽狍濠簌篝屙钺礤疳翳钺礤钺礤簌篝屙骈戾┅ㄤ镬轶钺礤犷洵溴疱钿孱汩弩ㄧ弭簌篝屙簌篝屙骈戾┅躅戾篌ㄢ灬汶扉篝邃痱镪邈舡钺礤簌篝屙钺礤忪徙氕犰轶舂瘐箬扉篝痱镪邈舡钺礤簌篝屙钺礤ㄦ轵篝钺礤犷洵溴疱钿孱汩弩蝈篝钺礤犷洵溴疱钿孱汩弩┅簌篝屙蟓轭骘┅┅换族狎痱轭糸铉溽翎麸溟篝骈戾镱禊换徭翦犰轭骘蝽狒轱麽泔祆邈翦洮忮汜躞换殒箫礤箫礤箝珙犰麽鏖祆忮蜥轶邃漉蜷铉换轭骘蝽狒轱泔祆邈糸镱麇滹铘麽铘换麸秕麴豸犷轭骘蝽狒轱徕秕翳轶怛镫孱簌篝屙ㄡ痧禊＇骘蝽狒蝈戾狍瀛轭溴狺狺ア蝈戾狍瀛轭骘ㄤ镬轶簌篝屙轭骘簌篝屙蟓轭骘ㄡ痧禊＇骘蝽狒簌篝屙轭溴狺狺ア簌篝屙轭骘┅┅┅┅┅ㄤ彐躅聃殂脘轶é脲钺礤鲥蝮轱呼镤狴忉箦躜痱镪邈趔溟溟篝蟓溟忪徙氕犰轶舂戾舄è鲥蝮轱ㄩ铒ㄥ鲥蝮轱呼镤狴┅鲥蝮轱ㄦ矧磲舡溽翦ㄧ弭躅轹弪筢飙糸礤┅┅痱镪邈趔疳翳ㄦ徜吼狒桀犴瀛狍溟蝈泗矧痱镡瀛骈戾痱镪邈趔溟颟┅翦眇灬翦溽翎扉篝侯犴钺礤忽弪箝镱鲥蝮轱衡狍瀛躜篝蜷铉蜷玷舡趄轫忉箦躜飑轰轶趔溟篝蜷铉蜷玷舡趄轫钺糸鲥钺礤篝蜷铉溟篝蟓溟颟┅ㄤ轶糸铈锃疳翳ㄦ徜吼狒桀犴瀛狍骈戾蝈钿弪翦眇灬翦溟篝轭骘骈戾翦眇灬翦翦眇灬翦溽翎┅ㄤ轶舡疳翳ㄦ徜吼狒桀犴瀛狍溟蝈泗矧蝈钿弪翦眇灬翦溟篝溟颦翦眇灬翦翦眇灬翦溽翎┅ㄡ蜚栝鲥疳翳ㄦ徜吼狒桀犴瀛狍溟蝈泗矧蝈钿弪翦眇灬翦狎汨轹瀛溟颦翦眇灬翦翦眇灬翦溽翎┅ㄡ蜚栝鲥躜蝈钿弪翦眇灬翦狎汨轹瀛躜飙翦眇灬翦翦眇灬翦溽翎┅ㄡ篌弪ㄦ徜轰轵邈麸蝙屮轶趔痱镪邈趔疳翳┅ㄥ铙躜瀛溟蝈泗矧殄蟓屮轶溟篝疳翳忽弪怙箦舂ㄥ铙躜瀛溟蝈泗矧殄蟓屮轶狎汨轹瀛疳翳忽弪怙箦舂ㄣ蝈狒瀛溟篝痱镪邈趔疳翳溟篝疳翳狎汨轹瀛疳翳狎汨轹瀛躜磲疸狎＇篝蜷铉殒扉篝忪徙氕犰轶舂戾è溟篝轭骘蝈钿弪翦眇灬翦溟篝轭骘翦眇灬翦翦眇灬翦溽翎┅ㄤ镬轶疳翳扉篝磲脲疳翳钺礤侯犴溟篝轭骘呼疱Ⅳ簪轰彐狨祠溟篝疳翳溟篝轭骘疳翳┅黩轸瀛篝蜷铉轭麸骈戾溟篝轭骘疳翳洪姝屮轶趔后躔弪箦溴┅鲠祯弩溟篝轭骘疳翳┅┅